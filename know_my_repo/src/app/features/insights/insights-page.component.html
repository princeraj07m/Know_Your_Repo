<div class="insights-page">
  <h1 class="insights-title">Insights</h1>

  @if (!hasData()) {
    <app-empty-state
      icon="fa-lightbulb"
      title="Insights"
      message="Analyze a codebase to get AI-powered insights and recommendations."
      actionLabel="Upload codebase"
      actionRoute="/upload"
    />
  } @else {
    @if (circularDependencies().length > 0) {
      <section class="insights-section circular-alert-section mb-4" [@fadeInUp]>
        <div class="circular-alert-card">
          <div class="circular-alert-icon">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <div class="circular-alert-body">
            <h2 class="circular-alert-title">Circular dependency detected</h2>
            <p class="circular-alert-desc mb-0">The following cycles were found. Consider refactoring to break the cycle.</p>
            <ul class="circular-alert-list mt-2 mb-0">
              @for (dep of circularDependencies(); track dep) {
                <li>{{ dep }}</li>
              }
            </ul>
          </div>
        </div>
      </section>
    }

    @if (risks().length > 0) {
      <section class="insights-section risk-badges-section mb-4" [@fadeInUp]>
        <h2 class="section-heading mb-3">
          <i class="fas fa-triangle-exclamation text-accent"></i>
          Risk indicators
        </h2>
        <div class="risk-badges">
          @for (r of risks(); track r.title) {
            <div class="risk-badge risk-badge--{{ r.severity ?? 'low' }}">
              <span class="risk-badge-label">{{ r.severity ?? 'low' }}</span>
              <span class="risk-badge-title">{{ r.title }}</span>
              @if (r.description) {
                <p class="risk-badge-desc small mb-0">{{ r.description }}</p>
              }
            </div>
          }
        </div>
      </section>
    }

    @if (topFiles().length > 0) {
      <section class="insights-section heatmap-section mb-4" [@fadeInUp]>
        <app-animated-card padding="lg" [hoverable]="true">
          <h2 class="section-heading mb-3">
            <i class="fas fa-fire text-accent"></i>
            Most important files
          </h2>
          <p class="text-secondary small mb-3">Files ranked by relevance to the codebase.</p>
          <ul class="heatmap-list list-unstyled mb-0">
            @for (f of topFiles(); track f.path; let i = $index) {
              <li class="heatmap-item" [class.heatmap-item--top3]="i < 3">
                <div class="heatmap-item-header">
                  <span class="heatmap-item-path">{{ f.label ?? f.path }}</span>
                  <span class="heatmap-item-pct">{{ f.importance }}%</span>
                </div>
                <progress
                  class="heatmap-progress"
                  [ngClass]="{
                    'progress-bar--high': f.importance >= 70,
                    'progress-bar--mid': f.importance >= 40 && f.importance < 70,
                    'progress-bar--low': f.importance < 40
                  }"
                  [value]="f.importance"
                  max="100"
                ></progress>
              </li>
            }
          </ul>
        </app-animated-card>
      </section>
    }

    @if (folderSection(); as folder) {
      <section class="insights-section folder-structure-section mb-4" [@fadeInUp]>
        <app-animated-card padding="lg" [hoverable]="true">
          <div class="folder-structure-header d-flex align-items-center justify-content-between mb-3">
            <h2 class="section-heading mb-0">
              <i class="fas fa-folder-tree text-accent"></i>
              Folder structure
            </h2>
            <span class="folder-structure-pill text-secondary">
              From analysis
            </span>
          </div>

          @if (folderRoots().length > 0) {
            <div class="folder-root-chips mb-3">
              @for (root of folderRoots(); track root) {
                <span class="folder-root-chip">
                  <i class="fas fa-folder"></i>
                  <span class="folder-root-label">{{ root }}</span>
                </span>
              }
            </div>
          }

          <pre class="folder-tree-code mb-0" aria-label="Folder structure">{{ folderTreeText() }}</pre>
        </app-animated-card>
      </section>
    }

    @if (executionSection() || readmeSection()) {
      <section class="insights-section mb-4" [@fadeInUp]>
        <div class="execution-readme-grid">
          @if (executionSection(); as exec) {
            <app-animated-card padding="lg" [hoverable]="false">
              <h2 class="section-heading mb-2">
                <i class="fas fa-diagram-project text-accent"></i>
                Execution flow (steps)
              </h2>
              <p class="text-secondary small mb-3">
                High-level sequence of how requests move through the system.
              </p>
              <ol class="execution-steps mb-0">
                @for (step of executionSteps(); track step; let i = $index) {
                  <li>
                    <span class="execution-step-index">{{ i + 1 }}</span>
                    <span class="execution-step-text">{{ step }}</span>
                  </li>
                }
              </ol>
            </app-animated-card>
          }

          @if (readmeSection(); as readme) {
            <app-animated-card padding="lg" [hoverable]="false">
              <h2 class="section-heading mb-2">
                <i class="fas fa-file-alt text-accent"></i>
                README highlights
              </h2>
              <p class="text-secondary small mb-3">
                Key points extracted from the project README.
              </p>
              <ul class="readme-bullets mb-0">
                @for (item of readmeBullets(); track item) {
                  <li>{{ item }}</li>
                }
              </ul>
            </app-animated-card>
          }
        </div>
      </section>
    }

    @if (summary(); as text) {
      <section class="mb-4" [@fadeInUp]>
        <app-animated-card padding="lg" [hoverable]="true">
          <h2 class="section-heading mb-3">
            <i class="fas fa-lightbulb text-accent"></i>
            Summary
          </h2>
          <p class="text-secondary mb-0">{{ text }}</p>
        </app-animated-card>
      </section>
    }

    @if (otherSections().length > 0) {
      <section [@fadeInUp]>
        <app-animated-card padding="lg" [hoverable]="false">
          <h2 class="section-heading mb-3">Sections</h2>
          <div class="insight-sections-grid">
            @for (section of otherSections(); track section.title) {
              <details class="insight-section">
                <summary class="insight-section-summary">
                  <span class="insight-section-dot"></span>
                  <span class="insight-section-title">{{ section.title }}</span>
                  <span class="insight-section-chevron">
                    <i class="fas fa-chevron-down"></i>
                  </span>
                </summary>
                <div class="insight-section-body">
                  <p class="text-secondary small mb-0">{{ section.content }}</p>
                </div>
              </details>
            }
          </div>
        </app-animated-card>
      </section>
    }

    @if (!summary() && sections().length === 0 && risks().length === 0 && importantFiles().length === 0 && circularDependencies().length === 0) {
      <p class="text-secondary">No insights available yet.</p>
    }
  }
</div>
