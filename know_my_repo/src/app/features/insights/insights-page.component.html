<div class="insights-page">
  <h1 class="insights-title">Insights</h1>

  @if (!hasData()) {
    <app-empty-state
      icon="fa-lightbulb"
      title="Insights"
      message="Analyze a codebase to get AI-powered insights and recommendations."
      actionLabel="Upload codebase"
      actionRoute="/upload"
    />
  } @else {
    @if (circularDependencies().length > 0) {
      <section class="insights-section insight-card insight-card--alert" [@fadeInUp]>
        <div class="circular-alert-card">
          <div class="circular-alert-icon">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <div class="circular-alert-body">
            <h2 class="circular-alert-title">Circular dependency detected</h2>
            <p class="circular-alert-desc mb-0">The following cycles were found. Consider refactoring to break the cycle.</p>
            <ul class="circular-alert-list mt-2 mb-0">
              @for (dep of circularDependencies(); track dep) {
                <li class="circular-alert-list-item">{{ dep }}</li>
              }
            </ul>
          </div>
        </div>
      </section>
    }

    @if (risks().length > 0) {
      <section class="insights-section" [@fadeInUp]>
        <h2 class="insight-section-heading">
          <i class="fas fa-triangle-exclamation insight-section-icon"></i>
          Risk indicators
        </h2>
        <div class="risk-badges">
          @for (r of risks(); track r.title) {
            <div class="risk-badge risk-badge--{{ r.severity ?? 'low' }}">
              <span class="risk-badge-label">{{ r.severity ?? 'low' }}</span>
              <span class="risk-badge-title">{{ r.title }}</span>
              @if (r.description) {
                <p class="risk-badge-desc mb-0">{{ r.description }}</p>
              }
            </div>
          }
        </div>
      </section>
    }

    @if (topFiles().length > 0) {
      <section class="insights-section" [@fadeInUp]>
        <div class="insight-card">
          <h2 class="insight-section-heading">
            <i class="fas fa-fire insight-section-icon"></i>
            Most important files
          </h2>
          <p class="insight-card-desc">Files ranked by relevance to the codebase.</p>
          <ul class="heatmap-list list-unstyled mb-0">
            @for (f of topFiles(); track f.path; let i = $index) {
              <li class="heatmap-item" [class.heatmap-item--top3]="i < 3">
                <div class="heatmap-item-header">
                  <span class="heatmap-item-path">{{ f.label ?? f.path }}</span>
                  <span class="heatmap-item-pct">{{ f.importance }}%</span>
                </div>
                <progress
                  class="heatmap-progress"
                  [ngClass]="{
                    'progress-bar--high': f.importance >= 70,
                    'progress-bar--mid': f.importance >= 40 && f.importance < 70,
                    'progress-bar--low': f.importance < 40
                  }"
                  [value]="f.importance"
                  max="100"
                ></progress>
              </li>
            }
          </ul>
        </div>
      </section>
    }

    @if (folderSection(); as folder) {
      <section class="insights-section" [@fadeInUp]>
        <div class="insight-card">
          <h2 class="insight-section-heading">
            <i class="fas fa-folder-tree insight-section-icon"></i>
            Folder structure
          </h2>
          @if (folderTreeText().trim()) {
            <app-file-tree [treeText]="folderTreeText()" class="insights-file-tree" />
          } @else {
            <p class="insight-empty-text">No folder structure available.</p>
          }
        </div>
      </section>
    }

    @if (executionSection()) {
      <section class="insights-section" [@fadeInUp]>
        <div class="insight-card">
          <h2 class="insight-section-heading">
            <i class="fas fa-diagram-project insight-section-icon"></i>
            Execution flow (steps)
          </h2>
          <p class="insight-card-desc">High-level sequence of how requests move through the system.</p>
          <div class="execution-timeline">
            @for (item of executionStepsParsed(); track $index) {
              @if (item.type === 'step') {
                <div class="timeline-step">
                  <div class="timeline-step-marker">
                    <span class="timeline-step-number">{{ item.index }}</span>
                  </div>
                  <div class="timeline-step-content">
                    <span class="timeline-step-title">{{ item.title }}</span>
                  </div>
                </div>
              }
              @if (item.type === 'routes') {
                <div class="timeline-step timeline-step--routes">
                  <div class="timeline-step-marker timeline-step-marker--routes">
                    <i class="fas fa-route"></i>
                  </div>
                  <div class="timeline-step-content">
                    <span class="timeline-step-title timeline-step-title--routes">Routes</span>
                    @if (item.routes && item.routes.length > 0) {
                      <div class="timeline-route-pills">
                        @for (route of item.routes; track route) {
                          <span class="route-pill">{{ route }}</span>
                        }
                      </div>
                    }
                  </div>
                </div>
              }
            }
          </div>
        </div>
      </section>
    }

    @if (readmeSection()) {
      <section class="insights-section" [@fadeInUp]>
        <div class="insight-card">
          <h2 class="insight-section-heading">
            <i class="fas fa-file-alt insight-section-icon"></i>
            README highlights
          </h2>
          <p class="insight-card-desc">Key points extracted from the project README.</p>
          <div class="readme-chips">
            @for (item of readmeBullets(); track item) {
              <span class="readme-chip">
                <i class="fas fa-check readme-chip-icon"></i>
                <span class="readme-chip-text">{{ item }}</span>
              </span>
            }
          </div>
        </div>
      </section>
    }

    @if (summaryCards().length > 0) {
      <section class="insights-section" [@fadeInUp]>
        <h2 class="insight-section-heading">
          <i class="fas fa-lightbulb insight-section-icon"></i>
          Summary
        </h2>
        <div class="summary-cards-grid">
          @for (card of summaryCards(); track card.label) {
            <div class="summary-kv-card">
              <span class="summary-kv-label">{{ card.label }}</span>
              <span class="summary-kv-value">{{ card.value }}</span>
            </div>
          }
        </div>
      </section>
    }

    @if (summary() && summaryCards().length === 0) {
      <section class="insights-section" [@fadeInUp]>
        <div class="insight-card">
          <h2 class="insight-section-heading">
            <i class="fas fa-lightbulb insight-section-icon"></i>
            Summary
          </h2>
          <p class="insight-summary-text">{{ summary() }}</p>
        </div>
      </section>
    }

    @if (otherSections().length > 0) {
      <section class="insights-section" [@fadeInUp]>
        <div class="insight-card">
          <h2 class="insight-section-heading">Sections</h2>
          <div class="insight-sections-grid">
            @for (section of otherSections(); track section.title) {
              <details class="insight-section-details">
                <summary class="insight-section-summary">
                  <span class="insight-section-dot"></span>
                  <span class="insight-section-title">{{ section.title }}</span>
                  <i class="fas fa-chevron-down insight-section-chevron"></i>
                </summary>
                <div class="insight-section-body">
                  <p class="insight-section-content">{{ section.content }}</p>
                </div>
              </details>
            }
          </div>
        </div>
      </section>
    }

    @if (!summary() && sections().length === 0 && risks().length === 0 && importantFiles().length === 0 && circularDependencies().length === 0) {
      <p class="insight-empty-text">No insights available yet.</p>
    }
  }
</div>
